{% extends 'base.html' %}
{% block content %}
<section class="form-card enhanced-form">
    <h2>{{ t('change_password') }}</h2>
    {% if policy_hint %}
    <p class="muted subtle">{{ t('password_policy_hint') }}: {{ policy_hint }}</p>
    {% endif %}
    <form method="post" class="form" id="change-password-form">
        <label>{{ t('old_password') }}
            <input type="password" name="old_password" required>
        </label>
        <label>{{ t('new_password') }}
            <input type="password" name="new_password" required>
        </label>
        <label>{{ t('password_confirm') }}
            <input type="password" name="confirm_password" required>
        </label>
        <label>{{ t('encryption_algorithm') }}
            <select name="algorithm" id="algorithm-select">
                {% for algorithm in algorithms %}
                <option value="{{ algorithm.id }}" data-requires-key="{{ 'true' if algorithm.requires_key else 'false' }}" data-hint="{{ algorithm.hint }}" data-description="{{ algorithm.description }}" {% if algorithm.id == selected_algorithm_id %}selected{% endif %}>{{ algorithm.name }}</option>
                {% endfor %}
            </select>
        </label>
        <div class="algorithm-details card">
            <div class="algorithm-details__header">{{ t('encryption_algorithm') }}</div>
            <p class="muted" data-role="algorithm-description">{{ algorithm_description }}</p>
            <p class="muted subtle" data-role="algorithm-hint">{{ key_hint }}</p>
        </div>
        <label id="encryption-key-field" class="{% if not requires_key %}hidden{% endif %}">{{ t('encryption_key') }}
            <input type="text" name="encryption_key" placeholder="{{ key_hint }}">
        </label>
        <button class="button full-width glow" type="submit">{{ t('submit') }}</button>
    </form>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
const changePasswordForm = document.getElementById('change-password-form');
if (changePasswordForm) {
    const algorithmsMeta = {{ algorithms|tojson }};
    const algorithmSelect = document.getElementById('algorithm-select');
    const keyField = document.getElementById('encryption-key-field');
    const keyInput = keyField ? keyField.querySelector('input') : null;
    const descriptionEl = changePasswordForm.querySelector('[data-role="algorithm-description"]');
    const hintEl = changePasswordForm.querySelector('[data-role="algorithm-hint"]');

    const updateAlgorithmDetails = () => {
        if (!algorithmSelect) {
            return;
        }
        const selected = algorithmsMeta.find(item => item.id === algorithmSelect.value);
        if (!selected) {
            return;
        }
        if (descriptionEl) {
            descriptionEl.textContent = selected.description || '';
        }
        if (hintEl) {
            hintEl.textContent = selected.hint || '';
        }
        if (keyField && keyInput) {
            if (selected.requires_key) {
                keyField.classList.remove('hidden');
                keyInput.placeholder = selected.hint || '';
            } else {
                keyField.classList.add('hidden');
                keyInput.value = '';
            }
        }
    };

    updateAlgorithmDetails();
    algorithmSelect?.addEventListener('change', updateAlgorithmDetails);
}
</script>
{% endblock %}
